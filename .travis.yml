language: minimal
scala:
  - 2.12.11

services:
  - docker

RUNCMD: "unidoc;test"

sctipt: |
  docker run -it --net=host \
    -e TRAVIS_SCALA_VERSION=$TRAVIS_SCALA_VERSION \
    -e TRAVIS_BUILD_DIR=$TRAVIS_BUILD_DIR \
    -e RUNCMD=$RUNCMD \
    -v $HOME/.ivy2:/root/.ivy2 \
    -v $HOME/.coursier:/root/.coursier \
    -v $HOME/.sbt:/root/.sbt \
    -v $TRAVIS_BUILD_DIR:/firrtl \
    tampler/chisel-crew-base:11 bash -c "
    set -e # exit on failure
    set -x # trace for debug
    cd /firrtl
    java --version
    verilator --version
    yosys -V
    chmod 777 .run_chisel_tests.sh
    chmod 777 .run_formal_checks.sh
    ./sbt -sbt-launch-dir ./launchers/ ++${TRAVIS_SCALA_VERSION} ${RUNCMD}
    ./.run_chisel_tests.sh
    ./.run_formal_checks.sh Ops
    "
    
after_script:
  - pwd 

cache:
  directories:
    - $HOME/.cache/coursier
    - $HOME/.ivy2/cache
    - $HOME/.sbt

before_cache:
  - rm -fv $HOME/.ivy2/.sbt.ivy.lock
  - find $HOME/.ivy2/cache -name "ivydata-*.properties" -print -delete
  - find $HOME/.sbt        -name "*.lock"               -print -delete
